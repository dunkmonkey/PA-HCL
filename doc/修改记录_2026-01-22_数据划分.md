# 预训练数据集划分修改记录

**日期**: 2026-01-22

## 修改内容

### 1. 实现受试者级数据划分

修改了 `scripts/pretrain.py`，实现了受试者级（subject-wise）的训练集/验证集划分，避免数据泄露。

### 2. 关键变更

#### 修改前
```python
# 分别创建训练集和验证集（但实际加载相同数据）
train_dataset = PCGPretrainDataset(
    data_dir=config.data.processed_dir,
    split="train",  # 此参数未被使用
    transform=transforms,
    num_substructures=config.data.num_substructures,
)

val_dataset = PCGPretrainDataset(
    data_dir=config.data.processed_dir,
    split="val",  # 此参数未被使用
    transform=transforms,
    num_substructures=config.data.num_substructures,
)
```

**问题**:
- ❌ `split` 参数未被使用，训练集和验证集加载了相同的所有数据
- ❌ 可能存在数据泄露（同一受试者的数据在训练和验证中）
- ❌ 无法真实评估模型的泛化能力

#### 修改后
```python
# 加载完整数据集
full_dataset = PCGPretrainDataset(
    data_dir=config.data.processed_dir,
    transform=transforms,
    num_substructures=config.data.num_substructures,
)

# 创建受试者级划分 (9:1 = 训练:验证)
train_indices, val_indices, _ = create_subject_wise_split(
    full_dataset,
    train_ratio=0.9,
    val_ratio=0.1,
    test_ratio=0.0,
    seed=args.seed
)

# 创建数据加载器（使用受试者级划分）
train_loader, val_loader, _ = create_dataloaders(
    full_dataset,
    train_indices=train_indices,
    val_indices=val_indices,
    batch_size=config.training.batch_size // world_size,
    num_workers=config.training.num_workers,
    distributed=args.distributed,
)
```

**改进**:
- ✅ 使用受试者级划分，确保同一受试者的所有数据在同一个集合中
- ✅ 训练集:验证集 = 9:1（参考 MoCo v3）
- ✅ 防止数据泄露
- ✅ 可以真实评估模型泛化能力

### 3. 数据增强策略

**训练集和验证集都使用相同的随机增强**，这是对比学习的标准做法：

```python
transforms = get_pretrain_transforms(sample_rate=config.data.sample_rate)
# 包含: TimeStretch, PitchShift, AddNoise, TimeShift, Normalize

# 训练集和验证集使用相同的增强分布
full_dataset = PCGPretrainDataset(
    data_dir=config.data.processed_dir,
    transform=transforms,  # 所有数据使用相同增强策略
    num_substructures=config.data.num_substructures,
)
```

**理由**:
1. ✅ 符合对比学习理论（SimCLR, MoCo v3）
2. ✅ 验证集可以评估模型对增强的鲁棒性
3. ✅ 训练和验证分布一致，避免分布偏移
4. ✅ 每次访问同一样本会生成不同的随机增强

### 4. 日志输出改进

```python
if is_main:
    logger.info(f"Total samples: {len(full_dataset)}")
    logger.info(f"Training samples: {len(train_indices)} ({len(train_indices)/len(full_dataset)*100:.1f}%)")
    logger.info(f"Validation samples: {len(val_indices)} ({len(val_indices)/len(full_dataset)*100:.1f}%)")
    logger.info("Using subject-wise split to prevent data leakage")
```

现在会明确显示:
- 总样本数
- 训练/验证样本数和百分比
- 使用了受试者级划分

## 参考文献

1. **MoCo v3** (Chen et al., 2021): An Empirical Study of Training Self-Supervised Vision Transformers
   - 使用相同的增强策略进行训练和验证
   - 验证损失用于监控训练进度

2. **SimCLR** (Chen et al., 2020): A Simple Framework for Contrastive Learning of Visual Representations
   - 验证集同样生成两个随机增强视图
   - 用于评估对比学习的表示质量

3. **Medical Self-supervised Learning** (Sowrirajan et al., 2021): Chasing Your Long Tails
   - 强调医学数据必须进行患者/受试者级划分
   - 防止数据泄露是医学 AI 的基本要求

## 测试

运行测试脚本验证修改:

```bash
python test_pretrain_split.py
```

预期输出:
- ✓ 总样本数统计
- ✓ 训练/验证集样本数和百分比
- ✓ 无数据泄露验证
- ✓ 受试者级划分验证
- ✓ 数据增强功能验证

## 向后兼容性

**完全兼容**: 此修改不影响:
- 配置文件格式
- 模型结构
- 训练器接口
- 检查点格式

唯一变化是数据加载方式，从"伪划分"改为"真正的受试者级划分"。

## 注意事项

1. **随机种子**: 使用 `--seed` 参数可以重现相同的数据划分
2. **分布式训练**: 自动支持 DDP，无需额外修改
3. **数据要求**: 原始数据必须按受试者组织（subject-wise）

## 后续工作

- [ ] 在下游任务微调中应用相同的受试者级划分
- [ ] 添加数据集统计信息（受试者数、样本分布等）
- [ ] 考虑添加 stratified split（按标签分层）用于下游任务
