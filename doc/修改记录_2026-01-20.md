# PA-HCL 下游任务微调系统实施记录

**日期**: 2026-01-20  
**版本**: v1.0  
**作者**: PA-HCL 团队

---

## 一、修改概述

本次修改实现了完整的**多任务下游微调系统**，支持三个公开数据集的五个下游任务。核心策略为：

1. **物理隔离**：预训练数据与微调数据完全分离在不同目录
2. **任务感知**：通过任务名称自动加载对应配置和数据
3. **类别权重**：自动计算并应用类别权重处理数据不平衡
4. **标准化接口**：统一的 CSV 格式和数据加载器

---

## 二、新增文件清单

### 2.1 核心数据准备脚本

| 文件路径 | 功能描述 |
|---------|---------|
| `scripts/data_preparation/prepare_downstream_tasks.py` | 多任务数据准备主脚本，支持 CirCor、PhysioNet 2016、PASCAL 数据集 |

**主要功能**：
- 解析各数据集的元数据和标签文件
- 按受试者进行 70:15:15 的训练/验证/测试划分
- 计算类别权重并保存到 CSV 注释行
- 生成标准化的任务配置文件 (JSON)
- 支持文件复制或硬链接两种模式

### 2.2 任务配置文件

| 文件路径 | 任务描述 |
|---------|---------|
| `configs/tasks/circor_murmur.yaml` | CirCor 杂音检测三分类 (Present/Absent/Unknown) |
| `configs/tasks/circor_outcome.yaml` | CirCor 临床结果二分类 (Normal/Abnormal) |
| `configs/tasks/physionet2016.yaml` | PhysioNet 2016 心音二分类 (Normal/Abnormal) |
| `configs/tasks/pascal.yaml` | PASCAL 心音三分类 (Normal/Murmur/Extrasystole) |

---

## 三、修改文件清单

### 3.1 src/data/dataset.py

**修改内容**：

1. **添加 `from_task()` 类方法**（第 493-567 行）
   - 支持通过任务名称直接创建数据集
   - 自动查找 CSV 文件和任务配置
   - 自动加载类别权重

2. **扩展 `_load_samples()` 方法**（第 356-450 行）
   - 支持解析 CSV 注释行中的类别权重
   - 格式：`# class_weights: [1.0, 2.0, 3.0]`

3. **添加 `create_task_dataloaders()` 函数**（第 810-922 行）
   - 一键创建训练/验证/测试数据加载器
   - 支持少样本学习的受试者级下采样

### 3.2 scripts/finetune.py

**修改内容**：

1. **添加 `--task` 参数**
   - 支持任务名称：`circor_murmur`, `circor_outcome`, `physionet2016`, `pascal`
   - 自动加载 `configs/tasks/{task}.yaml`

2. **添加 `--data-dir` 参数**
   - 指定下游数据目录（默认 `data/downstream`）

3. **重构数据加载逻辑**
   - 使用 `create_task_dataloaders()` 替代手动创建
   - 自动获取并应用类别权重

4. **添加配置合并逻辑**
   - 任务配置覆盖默认配置
   - 支持命令行参数进一步覆盖

### 3.3 src/trainers/downstream_trainer.py

**修改内容**：

1. **添加 `task_name` 参数**（第 145 行）
   - 用于日志和检查点命名

2. **添加 `primary_metric` 参数**（第 146 行）
   - 支持：`accuracy`, `f1`, `f1_macro`, `auroc`
   - 用于早停监控

3. **添加 `log_class_distribution()` 方法**（第 263-285 行）
   - 训练开始时打印类别分布
   - 显示类别权重

4. **扩展 `save_checkpoint()` 方法**
   - 保存任务名称到检查点

### 3.4 configs/finetune.yaml

**修改内容**：

1. **添加 `task` 配置块**
   ```yaml
   task:
     name: "default"
     type: "classification"
   ```

2. **添加 `evaluation` 配置块**
   ```yaml
   evaluation:
     primary_metric: "f1_macro"
     metrics: [accuracy, f1, f1_macro, auroc, precision, recall]
   ```

3. **添加 `training.use_class_weights` 选项**

---

## 四、数据流程图

```
原始数据                    预处理                      下游数据准备
─────────────────────────────────────────────────────────────────────
data/raw/                   data/processed/            data/downstream/
├── circor/                 ├── subject_10001/         ├── circor_murmur/
│   ├── data.csv           │   ├── rec_AV/            │   ├── train/
│   └── training_data/      │   │   ├── cycle_000.npy  │   │   └── subject_*/
│       └── *.wav          │   │   └── ...            │   ├── val/
├── physionet2016/          ├── subject_10002/         │   ├── test/
│   ├── REFERENCE.csv      │   └── ...                │   ├── train.csv
│   └── training-*/                                    │   ├── val.csv
│       └── *.wav                                      │   ├── test.csv
└── pascal/                                            │   └── task_config.json
    └── *.wav                                          ├── circor_outcome/
                                                       ├── physionet2016/
                                                       └── pascal/

   preprocess.py ────────────────────>    prepare_downstream_tasks.py ────>
```

---

## 五、CSV 文件格式规范

### 5.1 标准格式

```csv
# class_weights: [0.85, 1.23, 2.56]
subject_id,file_path,label,label_name,location,split
10001,train/subject_10001/rec_AV/cycle_000.npy,0,Present,AV,train
10001,train/subject_10001/rec_AV/cycle_001.npy,0,Present,AV,train
10001,train/subject_10001/rec_MV/cycle_000.npy,0,Present,MV,train
10002,train/subject_10002/rec_AV/cycle_000.npy,1,Absent,AV,train
```

### 5.2 字段说明

| 字段 | 类型 | 描述 |
|-----|------|------|
| `subject_id` | string | 受试者 ID |
| `file_path` | string | 相对于任务目录的 .npy 文件路径 |
| `label` | int | 整数标签 (0, 1, 2, ...) |
| `label_name` | string | 标签名称 (Present, Absent, Normal, ...) |
| `location` | string | 听诊位置 (AV, MV, PV, TV)，可为空 |
| `split` | string | 数据划分 (train, val, test) |

### 5.3 类别权重注释

训练集 CSV 文件的第一行为类别权重注释：
```
# class_weights: [w0, w1, w2, ...]
```

计算公式：`weight[i] = total_samples / (num_classes * count[i])`

---

## 六、任务配置文件格式

### 6.1 task_config.json

```json
{
    "task_name": "circor_murmur",
    "dataset": "circor",
    "task_type": "classification",
    "num_classes": 3,
    "label_map": {
        "Present": 0,
        "Absent": 1,
        "Unknown": 2
    },
    "class_weights": [0.85, 1.23, 2.56],
    "split_subjects": {
        "train": ["10001", "10002", ...],
        "val": ["10051", "10052", ...],
        "test": ["10071", "10072", ...]
    },
    "split_sizes": {
        "train": 12500,
        "val": 2500,
        "test": 2500
    },
    "primary_metric": "f1_macro"
}
```

### 6.2 YAML 任务配置

```yaml
# configs/tasks/circor_murmur.yaml
task:
  name: "circor_murmur"
  type: "classification"

data:
  base_dir: "data/downstream"
  task_name: "circor_murmur"

downstream:
  num_classes: 3
  label_map:
    Present: 0
    Absent: 1
    Unknown: 2
  use_class_weights: true

evaluation:
  primary_metric: "f1_macro"
```

---

## 七、支持的下游任务一览

| 任务名称 | 数据集 | 类别数 | 标签映射 | 主要评估指标 |
|---------|--------|-------|---------|-------------|
| `circor_murmur` | CirCor 2022 | 3 | Present→0, Absent→1, Unknown→2 | F1 (macro) |
| `circor_outcome` | CirCor 2022 | 2 | Normal→0, Abnormal→1 | AUROC |
| `physionet2016` | PhysioNet 2016 | 2 | Normal→0, Abnormal→1 | AUROC |
| `pascal` | PASCAL Challenge | 3 | Normal→0, Murmur→1, Extrasystole→2 | F1 (macro) |

---

## 八、技术细节

### 8.1 类别权重计算

采用 sklearn 风格的平衡权重计算：

```python
def compute_class_weights(labels: List[int], num_classes: int) -> List[float]:
    """
    计算类别权重用于处理不平衡数据
    
    公式: weight[i] = total / (num_classes * count[i])
    """
    label_counts = Counter(labels)
    total = len(labels)
    
    weights = []
    for i in range(num_classes):
        count = label_counts.get(i, 1)
        weight = total / (num_classes * count)
        weights.append(round(weight, 4))
    
    return weights
```

### 8.2 受试者级数据划分

确保同一受试者的所有样本在同一划分中，避免数据泄露：

```python
def split_subjects(
    subjects: List[str],
    ratios: Tuple[float, float, float] = (0.7, 0.15, 0.15),
    seed: int = 42
) -> Dict[str, List[str]]:
    """
    按受试者进行数据划分
    """
    random.seed(seed)
    subjects = subjects.copy()
    random.shuffle(subjects)
    
    n = len(subjects)
    train_end = int(n * ratios[0])
    val_end = train_end + int(n * ratios[1])
    
    return {
        "train": subjects[:train_end],
        "val": subjects[train_end:val_end],
        "test": subjects[val_end:]
    }
```

### 8.3 CirCor 多位置处理

CirCor 数据集每个受试者有四个听诊位置（AV, MV, PV, TV）的录音。当前策略：

- **受试者级划分**：同一受试者的四个位置录音都在同一划分中
- **样本级训练**：每个位置的每个周期作为独立样本参与训练
- **评估时**：可选按受试者聚合预测结果

---

## 九、依赖更新

请确保 `requirements.txt` 包含以下依赖：

```
pandas>=1.5.0
tqdm>=4.65.0
numpy>=1.24.0
scipy>=1.10.0
librosa>=0.10.0
pyyaml>=6.0
scikit-learn>=1.2.0
torch>=2.0.0
```

---

## 十、后续扩展计划

### 10.1 分割任务（第二阶段）

- 解析 CirCor 的 `.tsv` 分割标注文件
- 实现 `PCGSegmentationDataset` 类
- 添加分割损失函数（Dice Loss, Focal Loss）
- 添加分割评估指标（IoU, Boundary F1）

### 10.2 多任务联合训练

- 实现 `MultiTaskHead` 同时预测杂音和临床结果
- 添加多任务损失加权策略
- 支持任务间知识迁移

### 10.3 跨数据集评估

- 在 CirCor 上预训练，在 PhysioNet 2016 上评估
- 评估模型的泛化能力

---

## 十一、测试验证

### 11.1 语法检查

所有 Python 文件已通过语法检查：

```bash
python -m py_compile scripts/data_preparation/prepare_downstream_tasks.py  # ✓
python -m py_compile scripts/finetune.py  # ✓
python -m py_compile src/data/dataset.py  # ✓
python -m py_compile src/trainers/downstream_trainer.py  # ✓
```

### 11.2 配置文件验证

所有 YAML 配置文件已验证无语法错误。

---

**文档结束**
