# PA-HCL å®éªŒç›‘æ§åŠŸèƒ½å®ç°æ€»ç»“

**æ—¥æœŸ**: 2026-01-23  
**ç‰ˆæœ¬**: v1.0

---

## å®ç°å†…å®¹

æœ¬æ¬¡æ›´æ–°ä¸º PA-HCL é¡¹ç›®çš„ä¸‹æ¸¸å¾®è°ƒå®éªŒæ·»åŠ äº†å®Œæ•´çš„å®éªŒç›‘æ§æ”¯æŒï¼ŒåŒ…æ‹¬ **TensorBoard** å’Œ **WandB** ä¸¤ç§ç›‘æ§æ–¹å¼ã€‚

### ä¿®æ”¹çš„æ–‡ä»¶

1. **`src/trainers/downstream_trainer.py`**
   - æ·»åŠ  TensorBoard å’Œ WandB å¯¼å…¥ï¼ˆå¯é€‰ä¾èµ–ï¼‰
   - åœ¨ `__init__` æ–¹æ³•ä¸­æ·»åŠ  4 ä¸ªæ–°å‚æ•°ï¼š
     - `use_tensorboard`: å¯ç”¨ TensorBoard
     - `use_wandb`: å¯ç”¨ WandB
     - `wandb_project`: WandB é¡¹ç›®åç§°
     - `wandb_entity`: WandB ç”¨æˆ·/å›¢é˜Ÿå
   - åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è®°å½•ä»¥ä¸‹æŒ‡æ ‡ï¼š
     - è®­ç»ƒæŒ‡æ ‡ï¼ˆloss, accuracy, f1, precision, recallï¼‰
     - éªŒè¯æŒ‡æ ‡ï¼ˆloss, accuracy, f1, auroc, auprc ç­‰ï¼‰
     - æµ‹è¯•æŒ‡æ ‡ï¼ˆæ‰€æœ‰åˆ†ç±»æŒ‡æ ‡ï¼‰
     - å­¦ä¹ ç‡å˜åŒ–
   - è‡ªåŠ¨æ¸…ç†ï¼šè®­ç»ƒç»“æŸåå…³é—­ writer

2. **`scripts/finetune.py`**
   - æ·»åŠ å‘½ä»¤è¡Œå‚æ•°ç»„ "å®éªŒç›‘æ§"
   - æ–°å¢ 4 ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼š
     - `--tensorboard`: å¯ç”¨ TensorBoard
     - `--wandb`: å¯ç”¨ WandB
     - `--wandb-project`: WandB é¡¹ç›®åï¼ˆé»˜è®¤ "PA-HCL"ï¼‰
     - `--wandb-entity`: WandB å®ä½“åï¼ˆå¯é€‰ï¼‰
   - å°†å‚æ•°ä¼ é€’ç»™ DownstreamTrainer

3. **æ–°å»ºæ–‡æ¡£**
   - `doc/å®éªŒç›‘æ§ä½¿ç”¨æŒ‡å—.md`: è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£
   - `test_tracking.py`: åŠŸèƒ½æµ‹è¯•è„šæœ¬
   - `scripts/demo_tracking.sh`: äº¤äº’å¼ç¤ºä¾‹è„šæœ¬

---

## åŠŸèƒ½ç‰¹æ€§

### TensorBoard

- âœ… è®°å½•è®­ç»ƒ/éªŒè¯/æµ‹è¯•æŒ‡æ ‡
- âœ… è®°å½•å­¦ä¹ ç‡å˜åŒ–
- âœ… è½»é‡çº§ï¼Œæœ¬åœ°è¿è¡Œ
- âœ… æ”¯æŒå¤šå®éªŒå¯¹æ¯”
- âœ… å®æ—¶å¯è§†åŒ–

### WandB

- âœ… è®°å½•æ‰€æœ‰ TensorBoard çš„æŒ‡æ ‡
- âœ… é¢å¤–è®°å½•ç³»ç»Ÿèµ„æºï¼ˆGPUã€å†…å­˜ã€CPUï¼‰
- âœ… æ¨¡å‹æ¢¯åº¦å’Œå‚æ•°ç›‘æ§
- âœ… å®Œæ•´çš„é…ç½®è®°å½•
- âœ… äº‘ç«¯å­˜å‚¨ï¼Œå›¢é˜Ÿåä½œ
- âœ… è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Š

---

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

#### 1. ä½¿ç”¨ TensorBoard

```bash
# è®­ç»ƒæ—¶å¯ç”¨
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt \
    --tensorboard

# æŸ¥çœ‹ç»“æœ
tensorboard --logdir outputs/circor_murmur_finetune/tensorboard
```

#### 2. ä½¿ç”¨ WandB

```bash
# é¦–æ¬¡ä½¿ç”¨éœ€ç™»å½•
wandb login

# è®­ç»ƒæ—¶å¯ç”¨
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt \
    --wandb \
    --wandb-project PA-HCL-Downstream
```

#### 3. åŒæ—¶ä½¿ç”¨ä¸¤è€…

```bash
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt \
    --tensorboard \
    --wandb
```

### é«˜çº§ç”¨æ³•

#### çº¿æ€§è¯„ä¼° + TensorBoard

```bash
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt \
    --linear-eval \
    --tensorboard
```

#### å°‘æ ·æœ¬å­¦ä¹  + WandB

```bash
python scripts/finetune.py \
    --task physionet2016 \
    --pretrained checkpoints/pretrain/best_model.pt \
    --few-shot \
    --shot-ratio 0.1 \
    --wandb \
    --wandb-project PA-HCL-FewShot
```

#### æ‰¹é‡å®éªŒ

```bash
# å¯¹æ‰€æœ‰ä»»åŠ¡è¿è¡Œå®éªŒå¹¶ç›‘æ§
for task in circor_murmur circor_outcome physionet2016 pascal
do
    python scripts/finetune.py \
        --task $task \
        --pretrained checkpoints/pretrain/best_model.pt \
        --tensorboard \
        --wandb \
        --wandb-project PA-HCL-AllTasks
done

# å¯¹æ¯”æ‰€æœ‰å®éªŒ
tensorboard --logdir outputs
```

---

## è®°å½•çš„æŒ‡æ ‡

### è®­ç»ƒæŒ‡æ ‡ (train/)

- `train_loss`: è®­ç»ƒæŸå¤±
- `accuracy`: å‡†ç¡®ç‡
- `f1`: F1 åˆ†æ•°
- `precision`: ç²¾ç¡®ç‡
- `recall`: å¬å›ç‡

### éªŒè¯æŒ‡æ ‡ (val/)

- `val_loss`: éªŒè¯æŸå¤±
- `val_accuracy`: å‡†ç¡®ç‡
- `val_f1` / `val_f1_macro`: F1 åˆ†æ•°
- `val_auroc`: ROC AUC
- `val_auprc`: PR AUC
- `val_precision`: ç²¾ç¡®ç‡
- `val_recall`: å¬å›ç‡
- `val_sensitivity`: æ•æ„Ÿåº¦
- `val_specificity`: ç‰¹å¼‚åº¦

### æµ‹è¯•æŒ‡æ ‡ (test/)

æ‰€æœ‰éªŒè¯æŒ‡æ ‡ï¼Œä½¿ç”¨ `test_` å‰ç¼€

### å­¦ä¹ ç‡ (lr/)

- `lr/group_0`: ç¼–ç å™¨å­¦ä¹ ç‡
- `lr/group_1`: åˆ†ç±»å™¨å­¦ä¹ ç‡

### WandB é¢å¤–æŒ‡æ ‡

- ç³»ç»ŸæŒ‡æ ‡ï¼ˆGPU ä½¿ç”¨ç‡ã€å†…å­˜ã€CPUï¼‰
- æ¨¡å‹æ¢¯åº¦åˆ†å¸ƒ
- å‚æ•°æ›´æ–°ç»Ÿè®¡
- å®Œæ•´é…ç½®ä¿¡æ¯

---

## å…¼å®¹æ€§

### å¯é€‰ä¾èµ–

TensorBoard å’Œ WandB å‡ä¸ºå¯é€‰ä¾èµ–ï¼š

- å¦‚æœæœªå®‰è£…ï¼Œä¼šç»™å‡ºå‹å¥½çš„è­¦å‘Šä¿¡æ¯
- è®­ç»ƒå¯ä»¥æ­£å¸¸è¿›è¡Œï¼Œåªæ˜¯ä¸ä¼šè®°å½•ç›‘æ§æ•°æ®
- ä¸ä¼šå¯¼è‡´ç¨‹åºå´©æºƒ

### å®‰è£…

```bash
# å®‰è£… TensorBoardï¼ˆé€šå¸¸å·²åŒ…å«åœ¨ PyTorch ä¸­ï¼‰
pip install tensorboard

# å®‰è£… WandB
pip install wandb
```

### å‘åå…¼å®¹

- æ‰€æœ‰æ–°å‚æ•°éƒ½æœ‰é»˜è®¤å€¼ï¼ˆé»˜è®¤ç¦ç”¨ç›‘æ§ï¼‰
- ç°æœ‰çš„è®­ç»ƒè„šæœ¬æ— éœ€ä¿®æ”¹å³å¯æ­£å¸¸è¿è¡Œ
- åªæœ‰æ˜¾å¼æŒ‡å®šå‚æ•°æ‰ä¼šå¯ç”¨ç›‘æ§

---

## å¿«é€Ÿæµ‹è¯•

### è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
python test_tracking.py
```

æ£€æŸ¥é¡¹ï¼š
- TensorBoard æ˜¯å¦å¯ç”¨
- WandB æ˜¯å¦å¯ç”¨
- è®­ç»ƒå™¨å‚æ•°æ˜¯å¦æ­£ç¡®æ·»åŠ 
- å¾®è°ƒè„šæœ¬å‚æ•°æ˜¯å¦æ­£ç¡®æ·»åŠ 

### è¿è¡Œç¤ºä¾‹è„šæœ¬

```bash
bash scripts/demo_tracking.sh
```

äº¤äº’å¼é€‰æ‹©ç›‘æ§æ–¹å¼ï¼Œè¿è¡Œå¿«é€Ÿç¤ºä¾‹ã€‚

---

## ç›®å½•ç»“æ„

è®­ç»ƒåçš„è¾“å‡ºç»“æ„ï¼š

```
outputs/
â””â”€â”€ circor_murmur_finetune/
    â”œâ”€â”€ tensorboard/              # TensorBoard æ—¥å¿—
    â”‚   â””â”€â”€ events.out.tfevents.*
    â”œâ”€â”€ wandb/                    # WandB æœ¬åœ°ç¼“å­˜
    â”‚   â””â”€â”€ run-xxx/
    â”œâ”€â”€ train.log                 # è®­ç»ƒæ—¥å¿—
    â”œâ”€â”€ finetune.log              # å¾®è°ƒæ—¥å¿—
    â”œâ”€â”€ best_model.pt             # æœ€ä½³æ¨¡å‹
    â”œâ”€â”€ epoch_10.pt               # å®šæœŸæ£€æŸ¥ç‚¹
    â””â”€â”€ final_metrics.json        # æœ€ç»ˆæŒ‡æ ‡
```

---

## æœ€ä½³å®è·µ

### 1. æœ¬åœ°è°ƒè¯•

ä½¿ç”¨ TensorBoardï¼Œè½»é‡å¿«é€Ÿï¼š

```bash
python scripts/finetune.py --task ... --tensorboard
```

### 2. æ­£å¼å®éªŒ

ä½¿ç”¨ WandBï¼ŒåŠŸèƒ½å®Œæ•´ï¼š

```bash
python scripts/finetune.py --task ... --wandb --wandb-project MyProject
```

### 3. é‡è¦å®éªŒ

åŒæ—¶ä½¿ç”¨ä¸¤è€…ï¼ŒåŒé‡ä¿éšœï¼š

```bash
python scripts/finetune.py --task ... --tensorboard --wandb
```

### 4. å¯¹æ¯”å®éªŒ

åœ¨ TensorBoard ä¸­å¯¹æ¯”å¤šä¸ªå®éªŒï¼š

```bash
tensorboard --logdir outputs
```

åœ¨ WandB ä¸­ä½¿ç”¨ group å’Œ tags ç»„ç»‡å®éªŒã€‚

---

## æ•…éšœæ’é™¤

### TensorBoard ç«¯å£è¢«å ç”¨

```bash
tensorboard --logdir outputs --port 6007
```

### WandB ç™»å½•å¤±è´¥

```bash
wandb login --relogin
```

### ç¦»çº¿æ¨¡å¼

```bash
export WANDB_MODE=offline
python scripts/finetune.py --task ... --wandb
```

### ç¦ç”¨ä»£ç ä¸Šä¼ 

```bash
export WANDB_DISABLE_CODE=true
```

---

## ç¤ºä¾‹åœºæ™¯

### åœºæ™¯ 1ï¼šå¿«é€ŸéªŒè¯

**éœ€æ±‚**ï¼šå¿«é€ŸéªŒè¯æ¨¡å‹æ˜¯å¦æ”¶æ•›

**æ–¹æ¡ˆ**ï¼š
```bash
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt \
    --tensorboard \
    --epochs 10
```

### åœºæ™¯ 2ï¼šè¶…å‚æ•°æœç´¢

**éœ€æ±‚**ï¼šæµ‹è¯•ä¸åŒå­¦ä¹ ç‡

**æ–¹æ¡ˆ**ï¼š
```bash
for lr in 1e-3 5e-4 1e-4
do
    python scripts/finetune.py \
        --task circor_murmur \
        --pretrained checkpoints/pretrain/best_model.pt \
        --wandb \
        --wandb-project PA-HCL-HPSearch \
        --lr $lr \
        --experiment-name "lr_${lr}"
done
```

### åœºæ™¯ 3ï¼šå›¢é˜Ÿåä½œ

**éœ€æ±‚**ï¼šå›¢é˜Ÿæˆå‘˜å…±äº«å®éªŒç»“æœ

**æ–¹æ¡ˆ**ï¼š
```bash
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt \
    --wandb \
    --wandb-project PA-HCL-Team \
    --wandb-entity team-name
```

### åœºæ™¯ 4ï¼šè®ºæ–‡å®éªŒ

**éœ€æ±‚**ï¼šå¯å¤ç°çš„å®éªŒç»“æœ

**æ–¹æ¡ˆ**ï¼š
```bash
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt \
    --tensorboard \
    --wandb \
    --wandb-project PA-HCL-Paper \
    --seed 42
```

---

## ä¸‹ä¸€æ­¥

### å¯èƒ½çš„æ‰©å±•

1. **é¢„è®­ç»ƒç›‘æ§**ï¼šä¸º `pretrain_trainer.py` æ·»åŠ ç›¸åŒåŠŸèƒ½
2. **è‡ªå®šä¹‰æŒ‡æ ‡**ï¼šæ·»åŠ æ··æ·†çŸ©é˜µã€PR æ›²çº¿ç­‰å¯è§†åŒ–
3. **æ¨¡å‹å¯¹æ¯”**ï¼šè‡ªåŠ¨ç”Ÿæˆå¤šæ¨¡å‹å¯¹æ¯”æŠ¥å‘Š
4. **è¶…å‚æ•°ä¼˜åŒ–**ï¼šé›†æˆ WandB Sweeps
5. **æ€§èƒ½åˆ†æ**ï¼šæ·»åŠ è®­ç»ƒé€Ÿåº¦å’Œèµ„æºä½¿ç”¨ç›‘æ§

### ç»´æŠ¤å»ºè®®

1. å®šæœŸæ¸…ç†æ—§æ—¥å¿—ï¼š`find outputs -type f -mtime +30 -delete`
2. ä½¿ç”¨æœ‰æ„ä¹‰çš„å®éªŒåç§°
3. åœ¨ WandB ä¸­ä½¿ç”¨æ ‡ç­¾ç»„ç»‡å®éªŒ
4. å®šæœŸå¤‡ä»½é‡è¦å®éªŒç»“æœ

---

## æ€»ç»“

æœ¬æ¬¡å®ç°ä¸º PA-HCL é¡¹ç›®æ·»åŠ äº†ä¼ä¸šçº§çš„å®éªŒç›‘æ§èƒ½åŠ›ï¼š

âœ… **æ˜“ç”¨æ€§**ï¼šç®€å•çš„å‘½ä»¤è¡Œå‚æ•°å³å¯å¯ç”¨  
âœ… **çµæ´»æ€§**ï¼šæ”¯æŒå¤šç§ç›‘æ§æ–¹å¼ï¼Œå¯æŒ‰éœ€é€‰æ‹©  
âœ… **å®Œæ•´æ€§**ï¼šè®°å½•æ‰€æœ‰é‡è¦æŒ‡æ ‡å’Œé…ç½®  
âœ… **å¯é æ€§**ï¼šå¯é€‰ä¾èµ–ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½  
âœ… **å…¼å®¹æ€§**ï¼šå‘åå…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç   

ç°åœ¨ä½ å¯ä»¥ï¼š
- å®æ—¶ç›‘æ§è®­ç»ƒè¿‡ç¨‹
- å¯¹æ¯”ä¸åŒå®éªŒç»“æœ
- ä¸å›¢é˜Ÿå…±äº«å®éªŒæ•°æ®
- ç”Ÿæˆå¯å¤ç°çš„å®éªŒè®°å½•

å¼€å§‹ä½¿ç”¨ï¼š
```bash
python scripts/finetune.py --task circor_murmur --pretrained ... --tensorboard --wandb
```

ç¥å®éªŒé¡ºåˆ©ï¼ğŸš€
