# PA-HCL 项目介绍文档

## 项目概述

**PA-HCL (Physiology-Aware Hierarchical Contrastive Learning)** 是一个面向心音（PCG）信号的生理感知分层对比学习框架，用于自监督预训练和下游临床任务。

### 核心理念

心音信号与普通音频信号（语音、音乐等）有本质区别：
- 具有明确的生理生成机制（心脏机械活动）
- 具有准周期性结构（心动周期）
- 具有内部层次结构（S1、收缩期、S2、舒张期）
- 局部异常往往反映病理特征（杂音、异常音）

PA-HCL 充分利用心音的这些生理特性，设计了一种层次化的自监督学习方法，能够：
1. 在心动周期级别学习全局节律模式（对心率变化鲁棒）
2. 在子结构级别捕捉局部病理特征（杂音、异常音）
3. 学习可迁移到多种下游任务的通用表示

---

## 项目背景与动机

### 临床意义

心音听诊是心脏疾病诊断的重要手段，但存在以下挑战：
- 需要临床医生的专业经验
- 人工听诊主观性强，一致性差
- 先天性心脏病等疾病筛查需要大规模自动化

### 技术挑战

1. **标注成本高**：心音数据标注需要医学专家，成本高昂且耗时
2. **数据稀缺**：相比自然图像或语音，医疗数据规模小
3. **现有方法不足**：
   - 通用音频自监督方法（wav2vec2、BYOL-A等）未考虑心音生理结构
   - 监督学习方法依赖大量标注数据
   - 端到端方法缺乏可解释性

### 解决方案

PA-HCL 提出了一种**生理结构感知的自监督学习方法**：
- 无需人工标注即可从大量心音数据中学习
- 通过层次化对比学习捕捉多尺度特征
- 结合 CNN 和 Mamba（状态空间模型）实现高效长序列建模

---

## 核心技术架构

### 1. 数据处理流程

#### 1.1 心动周期分割（弱结构近似）
```
原始心音信号 → 带通滤波 → 能量包络计算 → 峰值检测 → 心动周期切分
```

**关键特点**：
- 不依赖人工标注的 S1/S2 位置
- 使用动态阈值适应心率变异
- 生成固定长度的心动周期片段（如 0.8秒，4000个采样点）

#### 1.2 亚结构划分
每个心动周期均匀划分为 K 个子结构（默认 K=4）：
```
周期 → [sub_1, sub_2, sub_3, sub_4]
     ≈ [S1, 收缩期, S2, 舒张期]（统计意义上）
```

**优势**：
- 简单有效，易于实现
- 无需精确分割，统计上保持一致性
- 方便进行消融实验（K=2/4/6）

### 2. 模型架构

#### 2.1 CNN-Mamba 编码器

**设计哲学**：局部 + 全局特征融合

```
输入信号 [B, 1, L]
    ↓
CNN Backbone（多尺度卷积）
    - 层1: [32, kernel=7, stride=2]  ← 提取局部纹理
    - 层2: [64, kernel=5, stride=2]  ← 中尺度模式
    - 层3: [128, kernel=5, stride=2] ← 高层抽象
    - 层4: [256, kernel=3, stride=2] ← 语义特征
    ↓
Mamba Layers (状态空间模型)
    - d_model: 256
    - n_layers: 4
    - d_state: 16
    - 线性复杂度 O(n)，高效处理长序列
    ↓
全局池化（Mean/Max）
    ↓
输出特征 [B, 256]
```

**为什么选择 Mamba？**
1. **线性复杂度**：相比 Transformer 的 O(n²)，Mamba 是 O(n)
2. **长程依赖**：心音信号较长（数秒），需要高效的全局建模
3. **选择性机制**：Mamba 的选择性状态空间能够自适应地记忆重要信息

#### 2.2 投影头设计

**周期级投影头**：
```python
Encoder Output [256] → MLP [256→512→128] → L2 Normalize
```

**子结构级投影头**：
```python
CNN中间特征 [128] → MLP [128→256→64] → L2 Normalize
```

### 3. 层次化对比学习损失

#### 3.1 周期级对比损失

目标：学习对心率变化鲁棒的全局表示

```python
L_cycle = InfoNCE(z_cycle_1, z_cycle_2)
        = -log(exp(sim(z_i, z_j)/τ) / Σ_k exp(sim(z_i, z_k)/τ))
```

**正样本对**：同一心动周期的两个增强视图  
**负样本**：来自其他周期/受试者的样本

#### 3.2 子结构级对比损失

目标：捕捉局部病理特征（杂音、异常音）

```python
L_sub = Σ_{k=1}^K InfoNCE(z_sub_k^1, z_sub_k^2)
```

**关键设计**：对齐相同位置的子结构
- sub_1 vs sub_1：对齐 S1 区域
- sub_2 vs sub_2：对齐收缩期
- sub_3 vs sub_3：对齐 S2 区域
- sub_4 vs sub_4：对齐舒张期

#### 3.3 总损失

```python
L_total = λ_cycle * L_cycle + λ_sub * L_sub
```

**默认权重**：
- λ_cycle = 1.0（周期级）
- λ_sub = 0.5 或 1.0（子结构级）

### 4. 数据增强策略

**生理约束的增强**：所有增强需保持心音生理有效性

#### 时域增强
- **时间平移**（Time Shift）：±10% 范围内循环移位
- **幅度缩放**（Amplitude Scale）：0.8-1.2 倍（模拟不同传感器灵敏度）
- **速度扰动**（Speed Perturbation）：0.9-1.1 倍（模拟心率变异）
- **高斯噪声**（Gaussian Noise）：SNR 20-40 dB（模拟环境噪声）

#### 频域增强
- **时间掩码**（Time Mask）：最多掩盖 30ms（不破坏心音主要成分）
- **频率掩码**（Frequency Mask）：最多掩盖 15% 频率带

**设计原则**：
- 心率变异范围基于生理学（60-180 bpm）
- 不破坏 S1-S2 的时序关系
- 增强幅度在临床可变性范围内

---

## 关键创新点

### 1. 生理结构感知的自监督学习

**创新**：首次在心音自监督学习中显式建模心动周期和子结构

**与现有方法对比**：
| 方法 | 结构建模 | 多尺度学习 | 领域知识 |
|------|---------|-----------|---------|
| wav2vec2 | ✗ | ✗ | 通用音频 |
| BYOL-A | ✗ | ✗ | 通用音频 |
| **PA-HCL** | ✓ | ✓ | 心音生理 |

### 2. 层次化对比学习

**创新**：同时在周期级和子结构级施加对比约束

**优势**：
- 周期级：学习全局节律，对心率变化鲁棒
- 子结构级：捕捉局部病理，对异常敏感
- 互补性：两个层次相互增强

### 3. CNN-Mamba 混合编码器

**创新**：结合 CNN 的局部特征提取和 Mamba 的高效全局建模

**对比**：
- **CNN-only**：缺乏全局依赖，感受野有限
- **CNN-Transformer**：全局建模但计算复杂度 O(n²)
- **CNN-Mamba**：全局建模 + 线性复杂度 O(n)

### 4. 弱结构近似

**创新**：无需精确的 S1/S2 标注即可利用生理结构

**意义**：
- 降低标注成本
- 保持自监督属性
- 适用于大规模数据

---

## 实验设计

### 预训练阶段

**目标**：从无标注心音数据学习通用表示

**设置**：
- 训练轮数：100 epochs
- 批次大小：64
- 优化器：AdamW（lr=1e-3, weight_decay=1e-4）
- 学习率调度：Cosine Annealing + 10 epochs warmup
- 混合精度：AMP（加速训练）

**数据划分**：按受试者划分（subject-wise split）
- 避免数据泄露
- 评估跨受试者泛化能力

### 下游任务

#### 1. 心脏病分类
- 任务：正常 vs 异常心音分类
- 评估指标：准确率、AUROC、F1-score
- 模式：线性评估 / 全量微调

#### 2. 异常检测
- 任务：检测心音中的异常模式（杂音等）
- 评估指标：AUROC
- 方法：
  - 仅用正常样本预训练
  - 基于表示空间距离检测异常

#### 3. 小样本学习
- 任务：少量标注数据下的分类
- 设置：10%、1% 训练数据
- 证明预训练表示的迁移能力

### 消融实验

#### 1. 层次结构消融
| 配置 | 周期级 | 子结构级 | 作用 |
|------|--------|---------|------|
| A | ✓ | ✗ | 验证周期级对比的作用 |
| B | ✗ | ✓ | 验证子结构级对比的作用 |
| C | ✓ | ✓ | 完整方法 |

#### 2. 编码器架构消融
- CNN-only
- CNN-Transformer
- CNN-Mamba（本文）

#### 3. 子结构数量消融
- K=2（粗粒度）
- K=4（默认）
- K=6（细粒度）

#### 4. 损失权重消融
- 不同的 λ_cycle 和 λ_sub 组合

---

## 技术栈

### 深度学习框架
- **PyTorch 2.1**：核心框架
- **torchaudio**：音频处理
- **mamba-ssm**：Mamba 状态空间模型实现

### 音频处理
- **librosa**：音频分析
- **scipy**：信号处理（滤波、重采样）
- **numpy**：数值计算

### 训练基础设施
- **accelerate**：分布式训练
- **AMP (Automatic Mixed Precision)**：混合精度训练
- **DDP (Distributed Data Parallel)**：多 GPU 训练

### 配置与实验管理
- **OmegaConf**：YAML 配置管理

- **wandb**：实验跟踪

### 开发工具
- **pytest**：单元测试
- **black**：代码格式化
- **isort**：导入排序
- **flake8**：代码检查

---

## 项目结构详解

```
PA-HCL/
├── configs/                    # 配置文件
│   ├── default.yaml           # 默认超参数
│   ├── pretrain.yaml          # 预训练配置
│   ├── finetune.yaml          # 微调配置
│   └── ablation.yaml          # 消融实验配置
│
├── src/                       # 核心源代码
│   ├── config.py              # 配置加载与管理
│   │
│   ├── data/                  # 数据处理模块
│   │   ├── preprocessing.py   # 信号预处理（滤波、周期分割）
│   │   ├── transforms.py      # 数据增强（时域、频域）
│   │   └── dataset.py         # PyTorch Dataset 类
│   │
│   ├── models/                # 模型架构
│   │   ├── mamba.py           # Mamba (SSM) 实现
│   │   ├── encoder.py         # CNN-Mamba 编码器
│   │   ├── heads.py           # 投影头、分类头
│   │   └── pahcl.py           # 完整 PA-HCL 模型
│   │
│   ├── losses/                # 损失函数
│   │   └── contrastive.py     # InfoNCE、层次化对比损失
│   │
│   ├── trainers/              # 训练器
│   │   ├── pretrain_trainer.py   # 预训练训练器
│   │   └── downstream_trainer.py # 下游任务训练器
│   │
│   └── utils/                 # 工具函数
│       ├── logging.py         # 日志工具
│       ├── metrics.py         # 评估指标
│       └── seed.py            # 随机种子设置
│
├── scripts/                   # 执行脚本
│   ├── preprocess.py          # 数据预处理
│   ├── pretrain.py            # 预训练主脚本
│   ├── finetune.py            # 微调主脚本
│   ├── evaluate.py            # 模型评估
│   └── ablation.py            # 消融实验
│
├── tests/                     # 单元测试
│   ├── test_encoder.py        # 编码器测试
│   ├── test_mamba.py          # Mamba 模块测试
│   ├── test_losses.py         # 损失函数测试
│   └── ...
│
├── data/                      # 数据目录
│   ├── raw/                   # 原始音频文件
│   └── processed/             # 预处理后的数据
│
├── checkpoints/               # 模型检查点
├── logs/                      # 训练日志
├── notebooks/                 # Jupyter 笔记本（分析）
└── doc/                       # 文档
    ├── 实验思路.md
    ├── 论文创新点.md
    └── 论文结构模板.md
```

---

## 应用场景

### 1. 先天性心脏病筛查
- 使用场景：新生儿心脏病筛查
- 优势：无需标注大量数据，预训练模型迁移到小样本场景

### 2. 心脏杂音检测
- 使用场景：瓣膜病变、先心病等导致的杂音
- 优势：子结构级对比学习特别适合捕捉局部异常

### 3. 心律失常监测
- 使用场景：房颤、早搏等节律异常
- 优势：周期级对比学习编码全局节律信息

### 4. 远程医疗
- 使用场景：家庭/社区健康监测
- 优势：轻量化模型，可部署到移动设备

---

## 技术优势总结

### 1. 科学严谨性
- 基于心音生理机制设计
- 符合临床认知
- 可解释性强

### 2. 工程完备性
- 模块化设计，易于扩展
- 完整的配置系统
- 全面的单元测试
- 支持分布式训练

### 3. 实验可复现性
- 固定随机种子
- 详细的配置记录
- 版本化的代码和依赖

### 4. 性能优化
- 混合精度训练（2倍加速）
- 梯度累积（支持大 batch size）
- Mamba 线性复杂度（相比 Transformer）

---

## 未来扩展方向

### 1. 模型改进
- 引入注意力机制可视化（解释模型关注区域）
- 多模态融合（PCG + ECG）
- 不确定性估计（临床决策支持）

### 2. 任务扩展
- 心音分割（S1/S2 精确定位）
- 心率估计
- 病理子类型分类

### 3. 数据增强
- 基于生成模型的增强（GAN、Diffusion）
- 跨数据集迁移学习

### 4. 部署优化
- 模型量化（INT8）
- 模型剪枝
- ONNX 导出

---

## 项目价值

### 学术价值
- 首次将生理结构引入心音自监督学习
- 提出层次化对比学习框架
- 探索 Mamba 在医疗信号处理中的应用

### 实用价值
- 降低心音分析的标注成本
- 提高模型在少样本场景的性能
- 为心脏病筛查提供自动化工具

### 开源贡献
- 提供完整的研究框架
- 可供研究者复现和扩展
- 推动医疗 AI 技术发展

---

## 参考文献

### 自监督学习
1. Chen, T., et al. (2020). A Simple Framework for Contrastive Learning of Visual Representations. ICML.
2. Grill, J. B., et al. (2020). Bootstrap Your Own Latent. NeurIPS.

### 音频自监督学习
3. Baevski, A., et al. (2020). wav2vec 2.0: A Framework for Self-Supervised Learning of Speech Representations. NeurIPS.
4. Niizumi, D., et al. (2021). BYOL for Audio: Self-Supervised Learning for General-Purpose Audio Representation. IJCNN.

### 状态空间模型
5. Gu, A., & Dao, T. (2023). Mamba: Linear-Time Sequence Modeling with Selective State Spaces. arXiv:2312.00752.

### 心音分析
6. Liu, C., et al. (2016). An Open Access Database for the Evaluation of Heart Sound Algorithms. Physiological Measurement.

---

## 联系与贡献

### 项目地址
- GitHub: https://github.com/dunkmonkey/PA-HCL

### 贡献方式
- Issue：报告 bug 或提出功能请求
- Pull Request：贡献代码或文档
- Discussion：技术讨论和问题解答

### 许可证
本项目采用 MIT 许可证，欢迎学术和商业使用。

---

**最后更新时间**：2026年1月
