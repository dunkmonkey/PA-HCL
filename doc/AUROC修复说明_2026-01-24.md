# AUROC/AUPRC è®¡ç®—é—®é¢˜ä¿®å¤è¯´æ˜

**æ—¥æœŸ**: 2026-01-24  
**é—®é¢˜**: ä¸‹æ¸¸å¾®è°ƒè¯„ä¼°æ—¶ AUROC å’Œ AUPRC å§‹ç»ˆè¿”å› 0.0  
**å½±å“**: æ— æ³•æ­£ç¡®è¯„ä¼°æ¨¡å‹æ€§èƒ½ï¼Œæ—©åœæœºåˆ¶å¤±æ•ˆ

---

## é—®é¢˜è¯Šæ–­

### åŸå§‹é—®é¢˜è¡¨ç°

ä»ç”¨æˆ·æä¾›çš„æ—¥å¿—ï¼š
```
2026-01-23 21:17:41 INFO Val Loss: 0.5524 Acc: 0.8785 F1: 0.7671 [auroc: 0.0000]
2026-01-23 21:18:33 INFO Test metrics: {..., 'test_auroc': 0.0, 'test_auprc': 0.0, ...}
```

### æ ¹æœ¬åŸå› 

1. **è®­ç»ƒé˜¶æ®µæœªæ”¶é›†æ¦‚ç‡**
   - `train_epoch()` åªæ”¶é›†é¢„æµ‹æ ‡ç­¾ï¼Œæ²¡æœ‰æ”¶é›† softmax æ¦‚ç‡
   - å¯¼è‡´è®­ç»ƒé›† AUROC/AUPRC æ— æ³•è®¡ç®—

2. **äºŒåˆ†ç±»æ¦‚ç‡æ ¼å¼é—®é¢˜**
   - è¯„ä¼°æ—¶ä¼ é€’å®Œæ•´æ¦‚ç‡çŸ©é˜µ `[N, 2]`
   - AUROC/AUPRC è®¡ç®—éœ€è¦æ­£ç±»æ¦‚ç‡ `[N]` æˆ–æ­£ç¡®å¤„ç†å¤šåˆ—æ¦‚ç‡

3. **å¤šåˆ†ç±» AUPRC ç¼ºå¤±**
   - åŸä»£ç åªä¸ºäºŒåˆ†ç±»è®¡ç®— AUPRC
   - å¤šåˆ†ç±»ä»»åŠ¡ï¼ˆå¦‚ CirCor murmur 3åˆ†ç±»ï¼‰æ²¡æœ‰ AUPRC æŒ‡æ ‡

4. **è¾¹ç•Œæƒ…å†µå¤„ç†ä¸è¶³**
   - å•ç±»åˆ«æ ·æœ¬æ—¶æŠ›å‡º ValueErrorï¼Œè¿”å› 0.0
   - ç¼ºå°‘å¿…è¦çš„ç±»åˆ«æ•°é‡æ£€æŸ¥

---

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ”¹è¿› `compute_auroc()` å‡½æ•°

**æ–‡ä»¶**: `src/utils/metrics.py`

**ä¿®æ”¹å†…å®¹**:
```python
def compute_auroc(
    y_true: Union[np.ndarray, List],
    y_score: Union[np.ndarray, List],
    multi_class: str = "ovr"
) -> float:
    y_true = np.asarray(y_true)
    y_score = np.asarray(y_score)
    
    # âœ… æ·»åŠ ç±»åˆ«æ•°é‡æ£€æŸ¥
    unique_classes = np.unique(y_true)
    if len(unique_classes) < 2:
        return 0.0
    
    try:
        if len(y_score.shape) == 1 or y_score.shape[1] == 1:
            return roc_auc_score(y_true, y_score.ravel())
        else:
            # âœ… å¤šåˆ†ç±»æ·»åŠ  average='macro'
            return roc_auc_score(y_true, y_score, multi_class=multi_class, average='macro')
    except (ValueError, IndexError) as e:
        # âœ… æ›´è¯¦ç»†çš„å¼‚å¸¸å¤„ç†
        import warnings
        warnings.warn(f"AUROCè®¡ç®—å¤±è´¥: {str(e)}ï¼Œè¿”å›0.0")
        return 0.0
```

### 2. æ”¹è¿› `compute_auprc()` å‡½æ•°

**ä¿®æ”¹å†…å®¹**:
```python
def compute_auprc(
    y_true: Union[np.ndarray, List],
    y_score: Union[np.ndarray, List],
    num_classes: Optional[int] = None  # âœ… æ–°å¢å‚æ•°
) -> float:
    y_true = np.asarray(y_true)
    y_score = np.asarray(y_score)
    
    # âœ… æ·»åŠ ç±»åˆ«æ•°é‡æ£€æŸ¥
    unique_classes = np.unique(y_true)
    if len(unique_classes) < 2:
        return 0.0
    
    try:
        if len(y_score.shape) == 1 or y_score.shape[1] == 1:
            return average_precision_score(y_true, y_score.ravel())
        else:
            # âœ… å¤šåˆ†ç±»æ”¯æŒï¼Œè®¡ç®— macro å¹³å‡
            return average_precision_score(y_true, y_score, average='macro')
    except (ValueError, IndexError) as e:
        import warnings
        warnings.warn(f"AUPRCè®¡ç®—å¤±è´¥: {str(e)}ï¼Œè¿”å›0.0")
        return 0.0
```

### 3. æ”¹è¿› `compute_metrics()` æ¦‚ç‡å¤„ç†

**ä¿®æ”¹å†…å®¹**:
```python
# åŸºäºåˆ†æ•°çš„æŒ‡æ ‡
if y_score is not None:
    y_score = np.asarray(y_score)
    
    # âœ… å¯¹äºäºŒåˆ†ç±»ï¼Œæå–æ­£ç±»æ¦‚ç‡
    if num_classes == 2 and len(y_score.shape) == 2 and y_score.shape[1] == 2:
        y_score_binary = y_score[:, 1]  # å–æ­£ç±»æ¦‚ç‡
        metrics["auroc"] = compute_auroc(y_true, y_score_binary)
        metrics["auprc"] = compute_auprc(y_true, y_score_binary, num_classes)
    else:
        # å¤šåˆ†ç±»æˆ–å·²ç»æ˜¯æ­£ç¡®æ ¼å¼
        metrics["auroc"] = compute_auroc(y_true, y_score)
        metrics["auprc"] = compute_auprc(y_true, y_score, num_classes)
else:
    # âœ… æ²¡æœ‰æ¦‚ç‡æ—¶æ˜¾å¼è®¾ç½®ä¸º 0.0
    metrics["auroc"] = 0.0
    metrics["auprc"] = 0.0
```

### 4. ä¿®å¤è®­ç»ƒé˜¶æ®µæ¦‚ç‡æ”¶é›†

**æ–‡ä»¶**: `src/trainers/downstream_trainer.py`

**ä¿®æ”¹å†…å®¹**:
```python
def train_epoch(self) -> Dict[str, float]:
    self.model.train()
    
    total_loss = 0.0
    all_preds = []
    all_labels = []
    all_probs = []  # âœ… æ–°å¢æ¦‚ç‡æ”¶é›†
    
    for batch_idx, batch in enumerate(self.train_loader):
        signals = batch["signal"].to(self.device)
        labels = batch["label"].to(self.device)
        
        with autocast(enabled=self.use_amp):
            logits = self.model(signals)
            loss = self.criterion(logits, labels)
        
        # ... åå‘ä¼ æ’­ ...
        
        # âœ… æ”¶é›†æ¦‚ç‡
        total_loss += loss.item()
        with torch.no_grad():
            probs = F.softmax(logits, dim=-1)
            preds = logits.argmax(dim=-1)
            all_preds.extend(preds.cpu().numpy())
            all_labels.extend(labels.cpu().numpy())
            all_probs.extend(probs.cpu().numpy())  # âœ… æ·»åŠ 
    
    # âœ… ä¼ é€’æ¦‚ç‡
    metrics = compute_classification_metrics(
        np.array(all_labels), 
        np.array(all_preds),
        np.array(all_probs)  # âœ… æ·»åŠ 
    )
```

### 5. æ·»åŠ è°ƒè¯•æ—¥å¿—

**ä¿®æ”¹å†…å®¹**:
```python
@torch.no_grad()
def evaluate(self, data_loader: DataLoader, prefix: str = "test") -> Dict[str, float]:
    # ... æ•°æ®æ”¶é›† ...
    
    all_labels_array = np.array(all_labels)
    all_preds_array = np.array(all_preds)
    all_probs_array = np.array(all_probs)
    
    # âœ… æ·»åŠ è°ƒè¯•ä¿¡æ¯
    if self.is_main_process and prefix == "test":
        self.logger.info(f"è¯„ä¼°æ•°æ®ç»Ÿè®¡:")
        self.logger.info(f"  æ ·æœ¬æ•°: {len(all_labels_array)}")
        self.logger.info(f"  æ ‡ç­¾èŒƒå›´: {all_labels_array.min()} - {all_labels_array.max()}")
        self.logger.info(f"  å”¯ä¸€æ ‡ç­¾: {np.unique(all_labels_array)}")
        self.logger.info(f"  æ¦‚ç‡å½¢çŠ¶: {all_probs_array.shape}")
        self.logger.info(f"  æ¦‚ç‡èŒƒå›´: {all_probs_array.min():.4f} - {all_probs_array.max():.4f}")
    
    metrics = compute_classification_metrics(
        all_labels_array, all_preds_array, all_probs_array
    )
```

---

## éªŒè¯æ–¹æ³•

### å¿«é€Ÿæµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯ä¿®å¤ï¼š
```bash
python test_auroc_fix.py
```

é¢„æœŸè¾“å‡ºï¼š
```
æµ‹è¯•äºŒåˆ†ç±» AUROC/AUPRC è®¡ç®—
  auroc: 0.XXXX  (ä¸ä¸º 0)
  auprc: 0.XXXX  (ä¸ä¸º 0)
âœ… äºŒåˆ†ç±»æµ‹è¯•é€šè¿‡!

æµ‹è¯•å¤šåˆ†ç±» AUROC/AUPRC è®¡ç®—
  auroc: 0.XXXX  (ä¸ä¸º 0)
  auprc: 0.XXXX  (ä¸ä¸º 0)
âœ… å¤šåˆ†ç±»æµ‹è¯•é€šè¿‡!

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

### å®é™…è®­ç»ƒéªŒè¯

é‡æ–°è¿è¡Œä¸‹æ¸¸å¾®è°ƒï¼š
```bash
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt \
    --experiment-name auroc_fixed
```

æ£€æŸ¥æ—¥å¿—è¾“å‡ºï¼š
```
# åº”è¯¥çœ‹åˆ°éé›¶çš„ AUROC/AUPRC
Epoch [1/50] Train Loss: 0.XXX Acc: 0.XXX F1: 0.XXX
  Val Loss: 0.XXX Acc: 0.XXX F1: 0.XXX [auroc: 0.85XX]  # âœ… ä¸å†æ˜¯ 0.0000

è¯„ä¼°æ•°æ®ç»Ÿè®¡:  # âœ… æ–°å¢è°ƒè¯•ä¿¡æ¯
  æ ·æœ¬æ•°: 271
  æ ‡ç­¾èŒƒå›´: 0 - 2
  å”¯ä¸€æ ‡ç­¾: [0 1 2]
  æ¦‚ç‡å½¢çŠ¶: (271, 3)
  æ¦‚ç‡èŒƒå›´: 0.0012 - 0.9988

Test metrics: {..., 'test_auroc': 0.87XX, 'test_auprc': 0.82XX, ...}  # âœ… æ­£å¸¸å€¼
```

---

## å½±å“èŒƒå›´

### å—ç›Šçš„åŠŸèƒ½

1. **è¯„ä¼°æŒ‡æ ‡å‡†ç¡®æ€§**
   - AUROC å’Œ AUPRC ç°åœ¨èƒ½æ­£ç¡®è®¡ç®—
   - æ”¯æŒäºŒåˆ†ç±»å’Œå¤šåˆ†ç±»ä»»åŠ¡

2. **æ—©åœæœºåˆ¶**
   - å¯ä»¥ä½¿ç”¨ `auroc` ä½œä¸º `primary_metric`
   - è®­ç»ƒèƒ½æ­£å¸¸ç›‘æ§å’Œæ—©åœ

3. **WandB/TensorBoard ç›‘æ§**
   - è®­ç»ƒå’ŒéªŒè¯æ›²çº¿æ˜¾ç¤ºçœŸå® AUROC/AUPRC
   - ä¾¿äºå¯¹æ¯”å®éªŒ

### ä¸å—å½±å“çš„åŠŸèƒ½

- å…¶ä»–æŒ‡æ ‡ï¼ˆaccuracy, precision, recall, f1ï¼‰è®¡ç®—é€»è¾‘ä¸å˜
- æ¨¡å‹è®­ç»ƒå’Œæ¨ç†æµç¨‹ä¸å˜
- æ•°æ®åŠ è½½å’Œé¢„å¤„ç†ä¸å˜

---

## ç›¸å…³é…ç½®

### æ¨èçš„æ—©åœé…ç½®

ä¿®å¤åï¼Œå¯ä»¥å®‰å…¨ä½¿ç”¨ AUROC ä½œä¸ºæ—©åœæŒ‡æ ‡ï¼š

```yaml
# configs/finetune.yaml
evaluation:
  primary_metric: "auroc"  # âœ… ç°åœ¨å¯ä»¥ä½¿ç”¨
  
downstream:
  early_stopping_patience: 15
  early_stopping_metric: "auroc"  # æˆ– "f1_macro"
  early_stopping_mode: "max"
```

---

## åç»­å»ºè®®

1. **æµ‹è¯•è¦†ç›–**
   - å°† `test_auroc_fix.py` é›†æˆåˆ° CI/CD
   - æ·»åŠ æ›´å¤šè¾¹ç•Œæƒ…å†µæµ‹è¯•

2. **æ€§èƒ½ç›‘æ§**
   - åœ¨ WandB ä¸­å¯¹æ¯”ä¿®å¤å‰åçš„å®éªŒ
   - éªŒè¯ AUROC å€¼ä¸æ–‡çŒ®æŠ¥å‘Šä¸€è‡´

3. **æ–‡æ¡£æ›´æ–°**
   - æ›´æ–°ä½¿ç”¨æŒ‡å—ä¸­çš„è¯„ä¼°æŒ‡æ ‡è¯´æ˜
   - åœ¨ç¤ºä¾‹ä¸­å±•ç¤º AUROC ç›‘æ§

---

## æ€»ç»“

âœ… **å·²è§£å†³**:
- AUROC/AUPRC è®¡ç®—è¿”å› 0.0 çš„é—®é¢˜
- è®­ç»ƒé˜¶æ®µç¼ºå°‘æ¦‚ç‡æ”¶é›†
- å¤šåˆ†ç±»ä»»åŠ¡ AUPRC ç¼ºå¤±
- è¾¹ç•Œæƒ…å†µå¤„ç†ä¸è¶³

âœ… **æ”¹è¿›**:
- æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- æ›´å¥å£®çš„å¼‚å¸¸å¤„ç†
- æ”¯æŒäºŒåˆ†ç±»å’Œå¤šåˆ†ç±»

âœ… **å…¼å®¹æ€§**:
- å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰ä»£ç 
- æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡

ğŸ¯ **ä¸‹ä¸€æ­¥**: 
- è¿è¡Œå®Œæ•´çš„ä¸‹æ¸¸å¾®è°ƒå®éªŒ
- éªŒè¯è¿‡æ‹Ÿåˆé—®é¢˜æ˜¯å¦æ”¹å–„ï¼ˆç»“åˆæ­£åˆ™åŒ–æ–¹æ¡ˆï¼‰
