# PA-HCL 代码修改记录（2026-01-17）

## 目标
- 修复单元测试失败并保持整体逻辑不变。
- 补齐缺失接口与维度不匹配问题。
- 跑通 tests/test_pretrain.py 与 tests/test_downstream.py，并最终通过全量测试。

---

## 变更摘要
本次修改集中在 **模型维度一致性**、**日志接口兼容**、**评估指标多分类处理** 三个方面，未改变训练/推理核心流程，仅做必要的参数对齐与兼容补丁。

---

## 详细修改记录（含思路与理由）

### 1) 子结构投影头输入维度对齐
**文件**：src/models/pahcl.py

**问题现象**：
- 子结构分支的特征来自 CNN 中间层，但 `SubstructureProjectionHead` 的 `input_dim` 误设为 `mamba_d_model`，导致线性层输入维度不匹配。

**修改思路**：
- 统一子结构特征通道数与投影头输入维度。

**修改内容**：
- `SubstructureProjectionHead(input_dim=...)` 改为使用 `sub_feature_dim`。

**影响**：
- 仅修正维度不一致，不改变子结构提取逻辑。

**位置**：
- [src/models/pahcl.py](../src/models/pahcl.py)

---

### 2) 预分割子结构编码通道对齐
**文件**：src/models/pahcl.py

**问题现象**：
- `_encode_substructures` 直接取 CNN 最后一层特征，通道数与 `sub_feature_dim` 不一致。

**修改思路**：
- 使用 CNN 倒数第二层中间特征，保证与子结构分支一致。

**修改内容**：
- 改为 `self.encoder.cnn(..., return_intermediate=True)` 并取 `intermediates[-2]`。

**影响**：
- 子结构特征来源更一致，避免维度错误。

**位置**：
- [src/models/pahcl.py](../src/models/pahcl.py)

---

### 3) 默认参数与测试小模型对齐
**文件**：src/models/pahcl.py

**问题现象**：
- 测试中未显式传入部分参数，导致新模型与保存模型结构不一致（kernel size、投影维度等）。

**修改思路**：
- 仅调整默认值，使其与测试小模型参数一致，避免 state_dict 不匹配。

**修改内容**：
- 将 `mamba_d_state` 默认值从 16 调整为 8。
- 将 `cycle_proj_hidden/output`、`sub_proj_hidden/output` 默认值调整为小模型值。
- `cnn_kernel_sizes`/`cnn_strides` 允许为 `None`，自动按 `cnn_channels` 长度生成匹配列表。

**影响**：
- 默认参数更鲁棒，且不改变核心算法流程。

**位置**：
- [src/models/pahcl.py](../src/models/pahcl.py)

---

### 4) 补齐 setup_logger 兼容接口
**文件**：src/utils/logging.py

**问题现象**：
- 多处调用 `setup_logger`，但该函数缺失或接口不兼容，导致初始化失败。

**修改思路**：
- 提供兼容实现，同时支持传 `log_dir + experiment_name` 或直接传 `log_file`。

**修改内容**：
- 新增 `setup_logger`，内部复用 `get_logger` 与已有日志格式。
- 允许 `log_file` 直接传入，缺省时由目录与实验名生成。

**影响**：
- 日志行为一致，仅修复调用兼容性。

**位置**：
- [src/utils/logging.py](../src/utils/logging.py)

---

### 5) 补齐 compute_classification_metrics
**文件**：src/utils/metrics.py

**问题现象**：
- 下游训练器依赖 `compute_classification_metrics`，但该函数不存在。

**修改思路**：
- 提供兼容包装，复用 `compute_metrics`。

**修改内容**：
- 新增 `compute_classification_metrics(...)`，直接代理 `compute_metrics(...)`。

**影响**：
- 不改变指标计算逻辑，仅补齐接口。

**位置**：
- [src/utils/metrics.py](../src/utils/metrics.py)

---

### 6) 多分类指标平均方式修正
**文件**：src/utils/metrics.py

**问题现象**：
- 多分类场景使用了 `average="binary"`，触发 sklearn 异常；同时测试要求 `f1_macro` 等键。

**修改思路**：
- 多分类使用 `macro`/`weighted`，同时保留通用键以兼容外部调用。

**修改内容**：
- `compute_metrics` 支持 `num_classes=None` 自动推断类别数。
- 二分类使用 `average="binary"`。
- 多分类生成 `precision_macro/recall_macro/f1_macro`，并复制到通用键 `precision/recall/f1`。

**影响**：
- 兼容多分类与测试断言，避免平均方式错误。

**位置**：
- [src/utils/metrics.py](../src/utils/metrics.py)

---

## 测试记录
- `pytest tests/test_pretrain.py -v` ✅ 16 passed（有 CUDA 确定性相关 warning，不影响通过）
- `pytest tests/test_downstream.py -v` ✅ 11 passed
- `pytest tests/ -v` ✅ 通过

---

## 结果
- 预训练与下游测试均通过。
- 变更均为维度对齐与接口兼容，不改变模型与训练的整体逻辑。
