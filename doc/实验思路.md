## 一、整体实验流程总览

主线：面向心音信号的生理结构感知自监督对比学习方法实验

阶段 0：数据准备与结构构建
阶段 1：自监督预训练（PA-HCL）
阶段 2：下游任务微调 / 线性评估
阶段 3：消融、泛化、可解释性实验

## 二、阶段 0：数据准备与结构构建（所有实验的地基）

### 2.1 原始数据组织
dataset/
├── private/
│   ├── subject_0001/
│   │   ├── rec_01.wav
│   │   ├── rec_02.wav
│   ├── subject_0002/
│   │   ├── rec_01.wav
│   └── ...
├── circulatory/
│   └── ...

**原则**
- 目录层级中必须保留 `subject_id`
- 后面所有 split 都是 **subject-wise**

### 2.2 心动周期构建脚本（一次性离线完成）
### 输入

- wav 文件
### 输出

- 周期切分后的 `.npy` 或 `.pt`
processed/
├── subject_0001/
│   ├── rec_01/
│   │   ├── cycle_000.npy
│   │   ├── cycle_001.npy
│   │   └── ...

### 核心逻辑（伪代码）
```python

for wav in recordings:
    signal = bandpass_filter(wav)
    envelope = energy_envelope(signal)
    peaks = peak_detection(envelope)
    cycles = split_by_peaks(signal, peaks)
    save(cycles)
```

补充：使用动态阈值（如平均值+3σ）避免**心律不齐**导致的错误分割

📌 **论文中说“弱结构近似”，代码里就体现为：不用任何标签**

### 2.3 亚结构构建（离线完成）
伪代码：
```python

def split_substructures(cycle, K=4):
    L = len(cycle)
    return [cycle[i*L//K:(i+1)*L//K] for i in range(K)]
```
📌 优点：
- 灵活
- 方便消融（K=2 / 4 / 6）

 **阶段0补充**：
- **心音质量评估与筛选**：尝试加入基于信噪比或周期完整性的过滤机制。
- **生理知识引导的亚结构划分**：可尝试基于心音定位（如S1/S2检测）进行非均匀划分，并与均匀划分做对比实验。
- **数据增强的医学约束**：增强操作应在生理合理范围内（如心率变异范围、频率漂移范围）。
## 三、阶段 1：自监督预训练（对应表 5-2）

### 3.1 预训练 Dataset 设计（最关键）
 **一个 batch 里有什么？**
- B 个心动周期
- 每个周期：
    - 2 个增强视图（cycle-level）
    - K 个亚结构 × 2 个增强视图（sub-level）
伪代码：
```python

class PCGPretrainDataset:
    def __getitem__(self, idx):
        cycle = load_cycle(idx)
        view1 = augment(cycle)
        view2 = augment(cycle)

        subs1 = [augment(s) for s in split_sub(cycle)]
        subs2 = [augment(s) for s in split_sub(cycle)]

        return view1, view2, subs1, subs2

```

### 3.2 模型 forward 的“信息流”
伪代码：
```python
# cycle-level
z_cycle_1 = encoder(view1)
z_cycle_2 = encoder(view2)

# sub-level
z_sub_1 = encoder(sub_view1, return_mid=True)
z_sub_2 = encoder(sub_view2, return_mid=True)

```
- `return_mid=True` → CNN 中间层
- encoder 参数 **共享**
### 3.3 损失计算（核心）
伪代码：
```python
L_cycle = info_nce(z_cycle_1, z_cycle_2)
L_sub = info_nce(z_sub_1, z_sub_2)

L = lambda1 * L_cycle + lambda2 * L_sub
```
### 表 5-2 中要记录的
- 编码器类型
- 参数量
- 预训练 epoch
- batch size
- 总时长

**阶段1补充**：

- **负样本策略**：明确负样本来源（同一subject不同周期？不同subject？），可设计对比实验。
- **投影头与预测头设计**：是否使用MLP、BN、非线性激活等，需说明。
- **学习率调度与优化器**：使用余弦退火 + warmup，优化器使用AdamW。
- **梯度累积与混合精度**：若GPU内存有限，应明确训练策略
## 四、阶段 2：下游任务（表 5-3 / 5-4 / 5-9）
### 4.1 下游 Dataset 统一规范
伪代码：
```python
class PCGDownstreamDataset:
    def __getitem__(self, idx):
        wav, label = load_wav_label(idx)
        return preprocess(wav), label
```
### split 方式（必须写进论文）
- train / val / test
- **subject-wise**
- 固定 random seed
### 4.2 微调策略（论文里要明确）
### 两种模式（可灵活选择）

#### 模式 A：线性评估（更“学术”）

- encoder freeze
- 只训练 classifier

#### 模式 B：全模型微调（更“实用”）

- encoder lr = 1e-4
- head lr = 1e-3

📌 表 5-3 可以放 **全微调结果**  
📌 补充材料放线性评估

### 4.3 表 5-3：主对比实验怎么跑？

需要以下 checkpoint：

| 方法              | checkpoint 来源 |
| --------------- | ------------- |
| CNN             | 随机初始化         |
| CNN-LSTM        | 随机初始化         |
| wav2vec2        | 官方            |
| BYOL-A          | 官方            |
| **PA-HCL（本实验）** | 阶段 1          |
同一微调脚本，不同初始化

### 4.4 表 5-4：异常检测实验（AUROC）
### 推荐做法

- 只用 **正常样本预训练**
- 测试时：
    - embedding → Mahalanobis / cosine distance
    - 不训练分类器
📌 强烈证明：**sub-level 对比真的学到了异常敏感特征**

## 五、阶段 3：消融与泛化（表 5-5 ～ 5-10）

### 5.1 表 5-5：层次结构消融（非常重要）

需要 **3 个预训练模型**：

|模型|L_cycle|L_sub|
|---|---|---|
|A|✅|❌|
|B|❌|✅|
|C|✅|✅|
📌 **其余全部配置完全一致**
### 5.2 表 5-6：编码器消融

只换 encoder：
- CNN
- CNN + Transformer
- CNN + Mamba（本实验）

📌 证明不是 loss 在“作弊”
### 5.3 表 5-7：λ 权重消融
(1.0, 0.0)
(0.7, 0.3)
(0.5, 0.5)
### 5.4 表 5-8：跨数据集泛化
私有数据 SSL 预训练
   ↓
CirCor 微调 / 线性评估
### 5.5 表 5-10：统计显著性（一定要做）
- 重复 5 次训练（不同 seed）
- 对比 baseline vs 本实验方法
- t-test / Wilcoxon
```python
scipy.stats.ttest_rel(a, b)
```

### 5.6 表征可视化与可解释性分析实验
- t-SNE / UMAP——可视化对比（预训练前后）
- Grad-CAM热力图示例（展示模型关注区域）
## 六、训练脚本推荐结构

PA-HCL/
├── pretrain.py
├── finetune.py
├── datasets/
│   ├── pretrain_dataset.py
│   ├── downstream_dataset.py
├── models/
│   ├── encoder.py
│   ├── projection.py
├── losses/
│   ├── info_nce.py
├── configs/
│   ├── pretrain.yaml
│   ├── finetune.yaml

📌 **配置文件 = 论文复现性的关键**


