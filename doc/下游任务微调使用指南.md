# PA-HCL 下游任务微调使用指南

**版本**: v1.0  
**最后更新**: 2026-01-20

---

## 目录

1. [快速开始](#1-快速开始)
2. [数据准备](#2-数据准备)
3. [微调训练](#3-微调训练)
4. [评估与测试](#4-评估与测试)
5. [高级用法](#5-高级用法)
6. [常见问题](#6-常见问题)
7. [配置参考](#7-配置参考)

---

## 1. 快速开始

### 1.1 环境准备

```bash
# 克隆项目
git clone https://github.com/dunkmonkey/PA-HCL.git
cd PA-HCL

# 创建虚拟环境
conda create -n pahcl python=3.10
conda activate pahcl

# 安装依赖
pip install -r requirements.txt
pip install -e .
```

### 1.2 一键运行（推荐）

```bash
# 完整流程：准备数据 -> 训练所有任务 -> 汇总结果
./scripts/run_downstream.sh all
```

### 1.3 单任务快速训练

```bash
# 假设已有预训练模型和准备好的数据
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt
```

---

## 2. 数据准备

### 2.1 数据集下载

#### CirCor DigiScope 2022

```bash
# 自动下载
python scripts/data_preparation/download_datasets.py --dataset circor

# 或手动下载
# 访问: https://physionet.org/content/circor-heart-sound/
# 下载并解压到: /root/autodl-tmp/data/raw/circor/
```

#### PhysioNet 2016

```bash
python scripts/data_preparation/download_datasets.py --dataset physionet2016
```

#### PASCAL Challenge

需手动下载:
1. 访问 https://istethoscope.peterjbentley.com/heartchallenge/
2. 下载数据集
3. 解压到 `/root/autodl-tmp/data/raw/pascal/`

### 2.2 预处理（提取心动周期）

```bash
# 预处理所有数据集
python scripts/preprocess.py \
    --raw_dir /root/autodl-tmp/data/raw \
    --output_dir /root/autodl-tmp/data/processed \
    --num_workers 8
```

**预处理输出结构**：
```
/root/autodl-tmp/data/processed/
├── subject_10001/
│   ├── rec_AV/
│   │   ├── cycle_000.npy
│   │   ├── cycle_001.npy
│   │   └── ...
│   ├── rec_MV/
│   ├── rec_PV/
│   └── rec_TV/
├── subject_10002/
│   └── ...
└── processing_stats.json
```

### 2.3 下游任务数据准备

#### 准备所有任务

```bash
python scripts/data_preparation/prepare_downstream_tasks.py \
    --dataset all \
    --raw-dir /root/autodl-tmp/data/raw \
    --processed-dir /root/autodl-tmp/data/processed \
    --output-dir /root/autodl-tmp/data/downstream \
    --seed 42 \
    --verbose
```

#### 准备特定数据集

```bash
# 仅准备 CirCor 数据集（包含 murmur 和 outcome 两个任务）
python scripts/data_preparation/prepare_downstream_tasks.py --dataset circor

# 仅准备 PhysioNet 2016
python scripts/data_preparation/prepare_downstream_tasks.py --dataset physionet2016

# 仅准备 PASCAL
python scripts/data_preparation/prepare_downstream_tasks.py --dataset pascal
```

#### 参数说明

| 参数 | 默认值 | 描述 |
|------|-------|------|
| `--dataset` | `all` | 数据集名称：`circor`, `physionet2016`, `pascal`, `all` |
| `--raw-dir` | `data/raw` | 原始数据目录 |
| `--processed-dir` | `data/processed` | 预处理数据目录 |
| `--output-dir` | `data/downstream` | 输出目录 |
| `--seed` | `42` | 随机种子（影响数据划分） |
| `--copy` | `False` | 使用文件复制而非硬链接 |
| `--verbose` | `False` | 显示详细日志 |

**输出结构**：
```
/root/autodl-tmp/data/downstream/
├── circor_murmur/
│   ├── train/
│   │   └── subject_10001/rec_AV/cycle_000.npy
│   ├── val/
│   ├── test/
│   ├── train.csv          # 包含类别权重
│   ├── val.csv
│   ├── test.csv
│   └── task_config.json   # 任务配置
├── circor_outcome/
├── physionet2016/
└── pascal/
```

---

## 3. 微调训练

### 3.1 基本用法

```bash
# 使用任务名称训练（推荐）
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt \
    --output-dir outputs \
    --experiment-name my_experiment
```

### 3.2 训练模式

#### 全量微调（默认）

编码器和分类器都参与训练：

```bash
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt
```

#### 线性评估

冻结编码器，只训练分类头：

```bash
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt \
    --linear-eval
```

#### 少样本学习

使用部分训练数据：

```bash
# 使用 10% 训练数据
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt \
    --few-shot --shot-ratio 0.1

# 使用 1% 训练数据
python scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt \
    --few-shot --shot-ratio 0.01
```

### 3.3 命令行参数

| 参数 | 默认值 | 描述 |
|------|-------|------|
| `--task` | 无 | 任务名称（必需或使用 --config） |
| `--config` | `configs/finetune.yaml` | 配置文件路径 |
| `--pretrained` | 无 | 预训练模型路径（必需） |
| `--data-dir` | `data/downstream` | 下游数据目录 |
| `--output-dir` | `outputs` | 输出目录 |
| `--experiment-name` | `downstream` | 实验名称 |
| `--linear-eval` | `False` | 线性评估模式 |
| `--few-shot` | `False` | 少样本学习模式 |
| `--shot-ratio` | `0.1` | 少样本比例 |
| `--epochs` | 配置文件 | 训练轮数 |
| `--lr` | 配置文件 | 学习率 |
| `--batch-size` | 配置文件 | 批次大小 |
| `--seed` | `42` | 随机种子 |

### 3.4 训练所有任务

#### 使用自动化脚本

```bash
# 训练所有任务（全量微调）
./scripts/run_downstream.sh train-all

# 训练所有任务（线性评估）
./scripts/run_downstream.sh train-all linear
```

#### 手动训练

```bash
# CirCor 杂音检测
python scripts/finetune.py --task circor_murmur --pretrained ...

# CirCor 临床结果
python scripts/finetune.py --task circor_outcome --pretrained ...

# PhysioNet 2016
python scripts/finetune.py --task physionet2016 --pretrained ...

# PASCAL
python scripts/finetune.py --task pascal --pretrained ...
```

### 3.5 多 GPU 训练

```bash
# 使用 4 个 GPU
torchrun --nproc_per_node=4 scripts/finetune.py \
    --task circor_murmur \
    --pretrained checkpoints/pretrain/best_model.pt \
    --batch-size 64
```

### 3.6 训练输出

```
outputs/circor_murmur_my_experiment/
├── config.yaml              # 保存的配置
├── train.log                # 训练日志
├── events.out.tfevents.*    # TensorBoard 日志
├── epoch_10.pt              # 周期检查点
├── epoch_20.pt
├── best_model.pt            # 最佳模型
├── final_model.pt           # 最终模型
└── final_metrics.json       # 最终评估指标
```

---

## 4. 评估与测试

### 4.1 训练后自动评估

训练结束后会自动在测试集上评估，结果保存在 `final_metrics.json`：

```json
{
    "test_accuracy": 0.8523,
    "test_f1": 0.8156,
    "test_f1_macro": 0.7892,
    "test_auroc": 0.9234,
    "test_precision": 0.8345,
    "test_recall": 0.7978
}
```

### 4.2 手动评估

```bash
python scripts/evaluate.py \
    --checkpoint outputs/circor_murmur_exp1/best_model.pt \
    --task circor_murmur \
    --data-dir data/downstream \
    --split test
```

### 4.3 查看 TensorBoard

```bash
tensorboard --logdir outputs/circor_murmur_exp1
```

### 4.4 汇总所有实验结果

```bash
./scripts/run_downstream.sh summarize
```

输出示例：
```
============================================================
实验结果汇总
============================================================
任务                 实验                           Accuracy     F1           AUROC
------------------------------------------------------------
circor_murmur        circor_murmur_exp1            0.8523       0.8156       0.9234
circor_outcome       circor_outcome_exp1           0.8912       0.8745       0.9456
physionet2016        physionet2016_exp1            0.8234       0.7989       0.8876
pascal               pascal_exp1                   0.7856       0.7523       0.8567
============================================================
```

---

## 5. 高级用法

### 5.1 自定义配置

创建自定义配置文件：

```yaml
# configs/my_config.yaml
task:
  name: "circor_murmur"
  type: "classification"

downstream:
  num_classes: 3
  num_epochs: 100
  batch_size: 64
  learning_rate: 5e-4
  weight_decay: 1e-4
  use_class_weights: true
  label_smoothing: 0.1

training:
  use_amp: true
  early_stopping_patience: 20

evaluation:
  primary_metric: "f1_macro"
```

使用自定义配置：

```bash
python scripts/finetune.py \
    --config configs/my_config.yaml \
    --pretrained checkpoints/pretrain/best_model.pt
```

### 5.2 超参数搜索

```bash
# 学习率搜索
for lr in 1e-3 5e-4 1e-4 5e-5; do
    python scripts/finetune.py \
        --task circor_murmur \
        --pretrained checkpoints/pretrain/best_model.pt \
        --lr $lr \
        --experiment-name "lr_${lr}"
done
```

### 5.3 跨数据集评估

在一个数据集上微调，在另一个数据集上评估：

```bash
# 在 CirCor 上微调
python scripts/finetune.py \
    --task circor_outcome \
    --pretrained checkpoints/pretrain/best_model.pt \
    --experiment-name circor_trained

# 在 PhysioNet 2016 上评估（需要标签映射一致）
python scripts/evaluate.py \
    --checkpoint outputs/circor_outcome_circor_trained/best_model.pt \
    --task physionet2016 \
    --data-dir /root/autodl-tmp/data/downstream
```

### 5.4 集成学习

```bash
# 训练多个模型
for seed in 42 123 456; do
    python scripts/finetune.py \
        --task circor_murmur \
        --pretrained checkpoints/pretrain/best_model.pt \
        --seed $seed \
        --experiment-name "seed_${seed}"
done

# 集成预测（需自行实现）
python scripts/ensemble.py \
    --checkpoints outputs/circor_murmur_seed_*/best_model.pt \
    --task circor_murmur
```

---

## 6. 常见问题

### 6.1 数据准备问题

**Q: 找不到标签文件**

```
WARNING: 未找到任何标签，请检查数据目录结构
```

**A**: 确保原始数据目录结构正确：
- CirCor: `/root/autodl-tmp/data/raw/circor/training_data/` 和 `/root/autodl-tmp/data/raw/circor/training_data.csv`
- PhysioNet 2016: `/root/autodl-tmp/data/raw/physionet2016/training-*/` 和 `REFERENCE.csv`

**Q: 预处理后没有周期文件**

**A**: 检查原始音频文件质量：
```bash
# 检查音频文件
python -c "
import librosa
audio, sr = librosa.load('/root/autodl-tmp/data/raw/circor/training_data/10001_AV.wav')
print(f'Duration: {len(audio)/sr:.2f}s, SR: {sr}')
"
```

### 6.2 训练问题

**Q: CUDA 内存不足**

**A**: 减小批次大小：
```bash
python scripts/finetune.py --task circor_murmur --batch-size 16
```

**Q: 训练不收敛**

**A**: 尝试：
1. 降低学习率：`--lr 1e-4`
2. 增加 warmup：修改配置 `warmup_epochs: 10`
3. 检查数据分布：查看 `train.csv` 中的类别比例

**Q: 类别不平衡导致模型偏向多数类**

**A**: 确保启用类别权重：
```bash
# 检查 CSV 是否包含类别权重
head -n 1 data/downstream/circor_murmur/train.csv
# 应显示: # class_weights: [...]
```

### 6.3 评估问题

**Q: 测试指标异常低**

**A**: 检查：
1. 训练集和测试集是否有数据泄露
2. 预训练模型是否正确加载
3. 标签映射是否正确

---

## 7. 配置参考

### 7.1 完整配置示例

```yaml
# configs/finetune.yaml

experiment:
  name: "pahcl_finetune"
  description: "PA-HCL 下游微调"

task:
  name: "default"
  type: "classification"

data:
  base_dir: "data/downstream"
  raw_dir: "data/raw"
  processed_dir: "data/processed"
  sample_rate: 5000
  target_length: 4000
  num_substructures: 4

model:
  encoder_type: "cnn_mamba"
  cnn_channels: [32, 64, 128, 256]
  cnn_kernel_sizes: [7, 5, 5, 3]
  cnn_strides: [2, 2, 2, 2]
  mamba_d_model: 256
  mamba_n_layers: 4

classifier:
  hidden_dim: 128
  dropout: 0.3

downstream:
  num_classes: 2
  label_map:
    normal: 0
    abnormal: 1
  hidden_dim: 128
  dropout: 0.3
  num_epochs: 100
  batch_size: 32
  learning_rate: 1e-3
  weight_decay: 1e-4
  warmup_epochs: 5
  early_stopping_patience: 15
  label_smoothing: 0.1
  use_class_weights: true

training:
  num_epochs: 100
  batch_size: 32
  learning_rate: 1e-3
  weight_decay: 1e-4
  warmup_epochs: 5
  min_lr: 1e-7
  encoder_lr_scale: 0.1
  label_smoothing: 0.1
  use_class_weights: true
  early_stopping_patience: 15
  grad_clip_norm: 1.0
  num_workers: 4
  use_amp: true
  log_interval: 20
  save_interval: 10

pretrain:
  checkpoint_path: "checkpoints/pretrain/best_model.pt"
  load_encoder_only: true
  freeze_encoder: false

evaluation:
  primary_metric: "f1_macro"
  metrics:
    - accuracy
    - f1
    - f1_macro
    - auroc
    - precision
    - recall
  save_confusion_matrix: true

seed: 42
```

### 7.2 任务特定配置

#### circor_murmur.yaml

```yaml
task:
  name: "circor_murmur"
  type: "classification"

downstream:
  num_classes: 3
  label_map:
    Present: 0
    Absent: 1
    Unknown: 2

evaluation:
  primary_metric: "f1_macro"
```

#### circor_outcome.yaml

```yaml
task:
  name: "circor_outcome"
  type: "classification"

downstream:
  num_classes: 2
  label_map:
    Normal: 0
    Abnormal: 1

evaluation:
  primary_metric: "auroc"
```

---

## 附录

### A. 支持的评估指标

| 指标 | 描述 | 适用场景 |
|------|------|---------|
| `accuracy` | 准确率 | 平衡数据集 |
| `f1` | F1 分数（二分类） | 二分类 |
| `f1_macro` | 宏平均 F1 | 多分类、不平衡数据 |
| `f1_weighted` | 加权 F1 | 多分类 |
| `auroc` | ROC 曲线下面积 | 二分类 |
| `auprc` | PR 曲线下面积 | 高度不平衡数据 |
| `precision` | 精确率 | 关注假阳性 |
| `recall` | 召回率 | 关注假阴性 |
| `specificity` | 特异性 | 医学诊断 |

### B. 数据集统计

| 数据集 | 受试者数 | 录音数 | 周期数（约） | 类别 |
|--------|---------|-------|-------------|------|
| CirCor 2022 | ~1000 | ~5000 | ~50000 | Murmur(3), Outcome(2) |
| PhysioNet 2016 | ~3000 | ~3000 | ~30000 | Normal/Abnormal |
| PASCAL | ~500 | ~1000 | ~10000 | Normal/Murmur/Extrasystole |

---

**文档结束**

如有问题，请提交 Issue 或联系项目维护者。
