# 类别不平衡问题优化指南

## 问题背景

在 PhysioNet 2016 心音分类任务中，我们遇到了典型的类别不平衡问题：
- **高召回率 (Recall)**：约 0.94 - 模型擅长识别异常样本
- **低特异性 (Specificity)**：约 0.35-0.46 - 模型经常误判正常样本为异常

这种不平衡导致模型倾向于预测为正类（异常），影响了临床实用性。

## 优化方案总结

本次更新实现了四个主要优化方向：

### 1. 阈值移动（无需重训练）

通过调整分类阈值，可以在不重新训练模型的情况下平衡召回率和特异性。

**使用方法：**

```bash
# 基础用法：使用 Youden's J 统计量找最优阈值
python scripts/find_optimal_threshold.py \
    --checkpoint outputs/supervised_baseline/physionet2016_cnn-mamba/best_model.pt \
    --task physionet2016

# 最大化 F1 分数
python scripts/find_optimal_threshold.py \
    --checkpoint path/to/model.pt \
    --task physionet2016 \
    --method f1

# 在保持 Recall >= 0.85 的前提下最大化 Specificity
python scripts/find_optimal_threshold.py \
    --checkpoint path/to/model.pt \
    --task physionet2016 \
    --method specificity

# 手动测试特定阈值
python scripts/find_optimal_threshold.py \
    --checkpoint path/to/model.pt \
    --task physionet2016 \
    --threshold 0.65
```

**输出：**
- `threshold_results.json`：包含最优阈值和各项指标
- `pr_roc_curves.png`：PR 曲线和 ROC 曲线图
- `threshold_metrics.png`：阈值 vs 各项指标的可视化

### 2. 类别平衡采样（WeightedRandomSampler）

在数据加载阶段使用加权采样，使每个批次中各类别样本数量接近平衡。

**启用方法：**

在 `configs/supervised_baseline.yaml` 中设置：
```yaml
training:
  use_balanced_sampling: true
```

**原理：**
- 少数类（异常）样本获得更高的采样权重
- 多数类（正常）样本权重较低
- 每个 epoch 期望各类别样本数量相等

**优点：**
- 不修改损失函数
- 简单有效
- 可与其他方法组合使用

### 3. 简化损失函数配置

将默认损失函数从 Focal Loss 改回 CrossEntropyLoss，因为实验表明 Focal Loss γ=2.0 过度抑制了正常样本的学习。

**配置说明：**

```yaml
training:
  # 推荐配置
  loss_type: "ce"              # 使用标准交叉熵
  use_balanced_sampling: true  # 配合平衡采样
  use_class_weights: true      # 可选：使用类别权重
  
  # 如果仍想使用 Focal Loss，降低 gamma
  # loss_type: "focal"
  # focal_gamma: 1.0  # 原来是 2.0，降低到 1.0
```

### 4. 多尺度并行卷积（可选架构改进）

新增 `MultiScaleConvBlock`，使用多个不同大小的卷积核并行处理输入：
- 小卷积核 (3): 高频局部特征（杂音高频成分）
- 中卷积核 (7): 中频模式（S1/S2 心音）
- 大卷积核 (15): 低频趋势（心动周期整体形态）

**启用方法：**

```yaml
model:
  use_multiscale: true
  multiscale_kernel_sizes: [3, 7, 15]
```

**注意：** 启用后参数量约增加 30%，建议先用默认配置验证平衡采样效果。

## 推荐实验流程

### 步骤 1：使用现有模型进行阈值移动

```bash
# 找到最优阈值
python scripts/find_optimal_threshold.py \
    --checkpoint your_model.pt \
    --task physionet2016 \
    --method balanced

# 查看结果
cat outputs/.../threshold_analysis/threshold_results.json
```

### 步骤 2：重新训练（使用平衡采样 + CE 损失）

```bash
# 修改配置后重新训练
python scripts/train_supervised_baseline.py \
    --task physionet2016 \
    --experiment-name balanced_ce_v1

# 配置要点:
# - use_balanced_sampling: true
# - loss_type: "ce"
# - use_class_weights: true
```

### 步骤 3：对比实验

```bash
# 实验 A: 仅平衡采样
training.use_balanced_sampling: true
training.loss_type: "ce"
training.use_class_weights: false

# 实验 B: 仅类别权重
training.use_balanced_sampling: false
training.loss_type: "ce"
training.use_class_weights: true

# 实验 C: 平衡采样 + 类别权重
training.use_balanced_sampling: true
training.loss_type: "ce"
training.use_class_weights: true
```

### 步骤 4：可选架构改进

```bash
# 测试多尺度卷积
python scripts/train_supervised_baseline.py \
    --task physionet2016 \
    --experiment-name multiscale_v1

# 配置:
model.use_multiscale: true
model.multiscale_kernel_sizes: [3, 7, 15]
```

## 文件修改清单

| 文件 | 修改内容 |
|------|----------|
| `scripts/find_optimal_threshold.py` | **新增** - 阈值优化工具脚本 |
| `src/data/dataset.py` | 添加 `get_sample_weights()` 方法 |
| `scripts/train_supervised_baseline.py` | 添加 `WeightedRandomSampler` 支持 |
| `src/models/encoder.py` | 添加 `MultiScaleConvBlock` 模块 |
| `src/models/__init__.py` | 导出 `MultiScaleConvBlock` |
| `configs/supervised_baseline.yaml` | 添加新配置项 |

## 配置文件完整示例

```yaml
# configs/supervised_baseline.yaml (关键配置)

model:
  encoder_type: "cnn_mamba"
  attention_type: "eca"          # 轻量级通道注意力
  drop_path_rate: 0.1            # 随机深度正则化
  use_bidirectional: false       # 双向 Mamba (可选)
  use_multiscale: false          # 多尺度卷积 (可选)
  multiscale_kernel_sizes: [3, 7, 15]

training:
  use_balanced_sampling: true    # ✓ 启用平衡采样
  loss_type: "ce"                # ✓ 使用标准交叉熵
  use_class_weights: true        # 使用类别权重
  focal_gamma: 1.0               # 如使用 Focal，降低 gamma

classifier:
  dropout: 0.5                   # 增大 dropout 缓解过拟合
```

## 预期效果

| 指标 | 优化前 | 预期优化后 |
|------|--------|------------|
| Specificity | 0.35-0.46 | 0.55-0.65 |
| Recall | 0.94 | 0.85-0.90 |
| Balanced Accuracy | 0.65-0.70 | 0.72-0.78 |
| F1 Score | 0.85-0.89 | 0.82-0.87 |

**注意：** 提高特异性通常会略微降低召回率，这是正常的权衡。目标是找到两者的最佳平衡点。

## 常见问题

**Q: 阈值移动和重训练哪个更好？**

A: 阈值移动是快速方案，适合对现有模型进行快速调优。但重训练（使用平衡采样）能让模型学习到更好的决策边界，长期效果更好。

**Q: 平衡采样会导致过拟合吗？**

A: 少数类样本会被重复采样，确实有过拟合风险。建议配合 DropPath、Dropout 等正则化手段。

**Q: 什么时候用多尺度卷积？**

A: 当基础配置已经达到瓶颈时再尝试。多尺度卷积增加参数量，需要更多训练数据才能发挥优势。

---

*更新日期: 2026-01-25*
*作者: PA-HCL 团队*
